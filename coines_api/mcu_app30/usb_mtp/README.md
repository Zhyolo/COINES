# Media Transfer Protocol (MTP) firmware for APP3.0

The external memory chip W25M02 on APP3.0 is based on NAND flash.

FAT filesystem on NAND flash memory results in a complicated solution which uses of lot of RAM. Moreover use of FAT without Flash Translation Layer (to save RAM) wears out NAND flash with frequent usage. Hence the choice of [FlogFS](https://github.com/conservify/FLogFS), a filesystem optimized for use with NAND flash.

But the use of `FlogFS`, presents a new problem 'Filesystem access from PC via USB'. Use of `FlogFS` with USB Mass Storage protocol is not possible because operating system can't recognize `FlogFS` as a valid filesystem.

Use of custom protocol to do filesystem operations would mean re-inventing the wheel and a lot of effort. User also would not have the same experience as with USB Mass Storage.

Solution was to go with the **Media Transfer Protocol** developed initially by Microsoft for Portable Devices like MP3 players. Starting from Android Kitkat (v4.4),MTP is the only way to access files on an Android device since the whole flash memory (included user storage space) uses filesystems like ext4, YAFFS, F2FS, etc.,

There were paid implementations of MTP for use on microcontroller but due to licensing restrictions on distribution and usage, it was decided to write a minimal MTP software stack from scratch with the below references.

- [MTP on Teensy 3.5](https://github.com/yoonghm/MTP)
- USB communication traces from Motorola G5 S+ :wink: captured using USBlyzer and Wireshark
- Android MTP stack from Google 
  - [mtp.h](https://android.googlesource.com/platform/frameworks/av/+/5c134e6/media/mtp/mtp.h)
  - [MTP library](https://android.googlesource.com/platform/frameworks/av/+/5c134e6/media/mtp/)
- [Official USB MTP Specification](https://www.usb.org/document-library/media-transfer-protocol-v11-spec-and-mtp-v11-adopters-agreement)
- [USB MTP Linux Gadget](https://github.com/viveris/uMTP-Responder/)

---

## Quick Start

### Building and flashing the firmware

Ensure that you have bootloader flashed on your board.

#### Build and MTP flash firmware with FLogFS support.

```bash
$ make FS=FLOGFS LOCATION=SPECIAL flash
```
To go to MTP mode,power on board with T1 button pressed

#### Testing MTP with a mock filesystem on RAM

It is sometimes easy to test MTP on a mock filesystem rather than a real filesystem.
See `storage/dummyfs`.
```
$ make FS=DUMMYFS LOCATION=RAM flash
```
---
## MTP command sequence and callbacks

### Startup
- MTP_OPERATION_OPEN_SESSION (0x1002) - **fs_init()**
- MTP_OPERATION_GET_DEVICE_INFO (0x1001) 
- MTP_OPERATION_GET_STORAGE_IDS (0x1004)
- MTP_OPERATION_GET_STORAGE_INFO (0x1005) - **fs_get_storage_info()**
- MTP_OPERATION_GET_DEVICE_PROP_DESC (0x1014)

### File listing

- MTP_OPERATION_GET_OBJECT_HANDLES (0x1007) - **fs_get_object_handles()** 
- MTP_OPERATION_GET_OBJECT_INFO (0x1008) - **fs_get_object_info_by_handle()**

### File read

- MTP_OPERATION_GET_OBJECT_INFO (0x1008) - **fs_get_object_info_by_handle()** 
- MTP_OPERATION_GET_OBJECT (0x1009) - **fs_file_read()**

### File write

- MTP_OPERATION_SEND_OBJECT_INFO (0x100C) - **fs_send_object_info_by_handle()** 
- MTP_OPERATION_SEND_OBJECT (0x100D) - **fs_file_write()**

### File delete

- MTP_OPERATION_DELETE_OBJECT (0x100B) - **fs_file_delete()**

### Filesystem format

- MTP_OPERATION_FORMAT_STORE (0x100F) - **fs_format()**

---
**Hints**

- In MTP each file/object is referenced by a number known as **handle**
- All file operations (read,write,delete,etc.,) are based on handles (See MTP filesystem interface handlers `mtp_operation_t` struct)
- Handles are generated by the device.Handle and file mapping should be maintained throughout the MTP session.
- `mtp_file_object_t []` array (see `mtp_support.h` ) should be populated during initialization.
---

## Porting MTP to a new filesystem

- Define `FS_START`.
  ```
  CFLAGS += -D FS_START=newfs_start
  ```
- Map MTP handlers with filesystem operations
  ```
  mtp_operation_t newfs_op = {
        .fs_init = newfs_init,
        .fs_format = newfs_format,
        .fs_get_storage_info = newfs_get_storage_info,
        .fs_get_object_handles = newfs_get_object_handles,
        .fs_get_object_info_by_handle = newfs_get_object_info_by_handle,
        .fs_file_read = newfs_file_read,
        .fs_file_delete = newfs_file_delete,
        .fs_send_object_info_by_handle = newfs_send_object_info_by_handle,
        .fs_file_write = newfs_file_write,
        .fs_deinit = newfs_deinit,
  };
  ```
  ```
    void newfs_start()
    {
       mtp_register_handlers(&newfs_op);
    }
  ```
- Use `storage/dummyfs` and `storage/flogfs_w25m02` as reference to fill code into the handlers `newfs_init`, `newfs_format`, etc .,
---

## Known Limitations

- Maximum of 128 files is accessible in a session (Reconfigure `mtp_config.h`)
- File name is limited to 32 characters (See `mtp_support.h`)
- No support for the following
  -  Directories/Folders
  -  Renaming files
  -  Partial read and write
     -  Applications attempting to do so will fail in Linux.
     -  Eg: `cat`, `cp`, input/output redirection, etc .,
     -  Try `gio copy` or `gvfs-copy` for copying files from MTP device.

